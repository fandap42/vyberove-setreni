---
title: "Úkol 1"
output: html_document
date: "2025-20-01"
---

```{r setup, include=FALSE}
library(readxl)
library(ggplot2)
library(dplyr)
library(tidyr)
library(knitr)
``` 

```{r}

#xlsx_path <- "D:/pavli/Dokumenty/git/vyberove-setreni/ukol1/Vysky.xlsx"
xlsx_path <- "C:/Users/pavli/Documents/git/vyberove-setreni/ukol1/Vysky.xlsx"

df <- read_excel(xlsx_path, col_names = FALSE, skip = 2)

pop_heights <- as.numeric(df[[2]])
pop_heights <- c(pop_heights, 172)  

pop_mean <- mean(pop_heights)
N <- length(pop_heights)

```

# Pravděpodobnostní rozdělení výběrového průměru
## 1) a 4)
Pravděpodobnostní rozdělení (pravděpodobnostní a distribuční funkci) výběrového průměru výšky studentů pro rozsahy výběru n=3,4,5 pro prostý náhodný výběr bez vracení.
Graficky porovnejte pravděpodobnostní rozdělení pro různé rozsahy výběru.

```{r}
ns <- c(3, 4, 5)

means_list <- lapply(ns, function(n) as.numeric(combn(pop_heights, n, FUN = mean)))
names(means_list) <- as.character(ns)

means_df <- do.call(rbind, lapply(names(means_list), function(n) {
    data.frame(mean = means_list[[n]], n = factor(n))
}))

x_grid <- seq(min(means_df$mean), max(means_df$mean), length.out = 512)

pdf_df <- do.call(rbind, lapply(names(means_list), function(n) {
    m <- means_list[[n]]
    d <- density(m, from = min(x_grid), to = max(x_grid), n = length(x_grid))
    data.frame(x = d$x, density = d$y, n = factor(n))
}))

cdf_df <- do.call(rbind, lapply(names(means_list), function(n) {
    m <- means_list[[n]]
    ec <- ecdf(m)
    data.frame(x = x_grid, cdf = ec(x_grid), n = factor(n))
}))

ggplot(pdf_df, aes(x = x, y = density, color = n, fill = n)) +
    geom_line(size = 1) +
    geom_ribbon(aes(ymin = 0, ymax = density), alpha = 0.15, color = NA) +
    labs(title = "Density estimate of sample mean (pdf)", x = "Sample mean", y = "Density", color = "n", fill = "n") +
    theme_minimal()

ggplot(cdf_df, aes(x = x, y = cdf, color = n)) +
    geom_line(size = 1) +
    labs(title = "Empirical CDF of sample mean", x = "Sample mean", y = "ECDF", color = "n") +
    theme_minimal()
```

## 2)
Pro rozsahy výběru n=3,4,5 vypočtěte střední hodnotu a rozptyl výběrového průměru výšky studentů v sledované populaci. Jsou výběrové průměry nestranné odhady populačního průměru? Vypočtěte vychýlení (bias) pro tyto odhady.

```{r sampling-stats, echo=FALSE}
ns <- sort(unique(as.character(means_df$n)))
results <- data.frame(n = integer(), empirical_mean = numeric(), empirical_var = numeric(), theoretical_var = numeric(), bias = numeric(), stringsAsFactors = FALSE)

pop_sigma2 <- var(pop_heights)

for (n_chr in ns) {
    n_num <- as.numeric(n_chr)
    means_n <- means_df$mean[as.character(means_df$n) == n_chr]
    emp_mean <- mean(means_n)
    emp_var <- var(means_n)
    theo_var <- (pop_sigma2 / n_num) * ((N - n_num) / (N - 1))
    bias <- emp_mean - pop_mean
    results <- rbind(results, data.frame(n = n_num, empirical_mean = emp_mean, empirical_var = emp_var, theoretical_var = theo_var, bias = bias))
}

kable(results, digits = 6, caption = 'Sampling distribution statistics computed from exact sample means (means_df)')

```

## 3)
Posuďte variabilitu odhadů pomocí vhodných popisných statistikami (variační koeficient, 1. a 9. decil, 1. a 3. kvartil, variační/mezikvartilové rozpětí).

```{r variability-stats, echo=FALSE}
ns <- sort(unique(as.character(means_df$n)))
var_stats <- data.frame(n = integer(), cv = numeric(), decil1 = numeric(), decil9 = numeric(), q1 = numeric(), q3 = numeric(), iqr = numeric(), R = numeric(), stringsAsFactors = FALSE)

for (n_chr in ns) {
    n_num <- as.numeric(n_chr)
    means_n <- means_df$mean[as.character(means_df$n) == n_chr]
    mu <- mean(means_n)
    sd_n <- sd(means_n)
    cv <- sd_n / mu
    decs <- quantile(means_n, probs = c(0.1, 0.9), names = FALSE)
    qs <- quantile(means_n, probs = c(0.25, 0.75), names = FALSE)
    iqr_n <- qs[2] - qs[1]
    R <- max(means_n) - min(means_n)
    var_stats <- rbind(var_stats, data.frame(n = n_num, cv = cv, decil1 = decs[1], decil9 = decs[2], q1 = qs[1], q3 = qs[2], iqr = iqr_n, R = R))
}

kable(var_stats, digits = 6, caption = 'Variability descriptors for sample mean by n')
```

# Pravděpodobnostní rozdělení relativní četnosti 

## 4) Relativní četnost a počet studentů vyšších než vámi

```{r proportion-counts, echo=FALSE, fig.width=7, fig.height=4}
# Define your height (change if needed)
if (!exists('my_height')) my_height <- 172

# number of students taller than 'you' in population
K <- sum(pop_heights > my_height)
cat('Population size N =', N, '- number taller than', my_height, 'K =', K, 'proportion p =', round(K/N,6), '\n')

ns <- c(3,4,5)
counts_df <- data.frame()
rel_df <- data.frame()
for (n in ns) {
    ks <- 0:n
    probs <- dhyper(ks, m = K, n = N - K, k = n)
    cdfv <- cumsum(probs)
    counts_df <- rbind(counts_df, data.frame(n = n, k = ks, prob = probs, cdf = cdfv))
    rel_df <- rbind(rel_df, data.frame(n = n, rel = ks / n, prob = probs, cdf = cdfv))
}

library(knitr)
cat('\n(i) PMF and CDF of relative frequency (k/n) for each n:\n')
for (n in ns) {
    cat('\n--- n =', n, '---\n')
    tab <- rel_df[rel_df$n == n, c('rel','prob','cdf')]
    print(kable(tab, digits = 6))
}

# (ii) mean, variance and bias for relative frequency (from pmf)
res_prop <- data.frame(n = integer(), mean_rel = numeric(), var_rel = numeric(), theo_mean = numeric(), theo_var = numeric(), bias = numeric(), stringsAsFactors = FALSE)
for (n in ns) {
    d <- rel_df[rel_df$n == n, ]
    mean_rel <- sum(d$rel * d$prob)
    second <- sum((d$rel^2) * d$prob)
    var_rel <- second - mean_rel^2
    p <- K / N
    theo_mean <- p
    theo_var <- (p * (1 - p) * ((N - n) / (N - 1))) / n
    bias <- mean_rel - theo_mean
    res_prop <- rbind(res_prop, data.frame(n = n, mean_rel = mean_rel, var_rel = var_rel, theo_mean = theo_mean, theo_var = theo_var, bias = bias))
}
cat('\n(ii) Mean, variance and bias of relative frequency (k/n):\n')
print(kable(res_prop, digits = 6))

# (iii) Graphically compare pmfs for different n (relative frequency)
library(ggplot2)
g1 <- ggplot(rel_df, aes(x = rel, y = prob, group = factor(n), color = factor(n))) +
    geom_step(direction = 'hv', size = 1) +
    geom_point() +
    labs(title = 'PMF of relative frequency (k/n) for different n', x = 'Relative frequency (k/n)', y = 'Probability', color = 'n') +
    theme_minimal()

g2 <- ggplot(rel_df, aes(x = rel, y = cdf, group = factor(n), color = factor(n))) +
    geom_step(direction = 'hv', size = 1) +
    labs(title = 'CDF of relative frequency (k/n) for different n', x = 'Relative frequency (k/n)', y = 'CDF', color = 'n') +
    theme_minimal()

print(g1)
print(g2)

# (iv) Distribution of counts k is hypergeometric
cat('\n(iv) Distribution of counts k (number of students taller than you) for each n. This is Hypergeometric(N, K, n).\n')
for (n in ns) {
    cat('\n--- n =', n, '---\n')
    tabc <- counts_df[counts_df$n == n, c('k','prob','cdf')]
    print(kable(tabc, digits = 6))
}

cat('\nPozn.: Distribuce počtu úspěchů při výběru bez vracení je hypergeometrická (Hypergeometric). Parametry: populace N, počet úspěchů K, rozsah výběru n.\n')
```




