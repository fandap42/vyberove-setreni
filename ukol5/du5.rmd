---
title: "Domácí úkol 5"
author: "Kateřina Bártová, František Pavlík"
date: "`r format(Sys.time(), '%d. %m. %Y')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)

student_data <- read.csv("testyDU5.csv")
```

```{r data_preparation}
set.seed(20020618) 

library(dplyr)
library(ggplot2)
library(sampling)

student_data$typ <- as.factor(student_data$typ)

N <- nrow(student_data)
n <- N / 10

true_mean <- mean(student_data$body)
true_var <- var(student_data$body)
true_sd <- sd(student_data$body)

M <- length(unique(student_data$id_cv))
m_c <- M / 10 
m_d <- M / 5  
```

### i) a ii).

#### a) 

Při prostém náhodném výběru bez vracení (SRSWOR) je odhad průměru nestranný.

```{r theo_a}
var_a <- (1 - n / N) * true_var / n
sd_a <- sqrt(var_a)
```
Teoretická směrodatná odchylka odhadu průměru je `r round(sd_a, 4)`.

#### b)

Jedná se o stratifikovaný výběr s proporcionální alokací. Odhad průměru je nestranný.

```{r theo_b}
strata_summary <- student_data %>%
  group_by(typ) %>%
  summarise(
    N_h = n(),
    S2_h = var(body)
  ) %>%
  mutate(W_h = N_h / N)

strata_summary$n_h <- n * strata_summary$W_h

var_b <- sum((1 - strata_summary$n_h / strata_summary$N_h) * strata_summary$W_h^2 * strata_summary$S2_h / strata_summary$n_h)
sd_b <- sqrt(var_b)
```
Teoretická směrodatná odchylka odhadu průměru je `r round(sd_b, 4)`.

#### c) 

Vybíráme 1/10 cvičení (8 cvičení) a opravíme všechny testy v nich. Odhad průměru je nestranný.

```{r theo_c}
cluster_means <- student_data %>%
  group_by(id_cv) %>%
  summarise(cluster_total = sum(body),
            cluster_mean = mean(body))

S2_b <- var(cluster_means$cluster_mean)

var_c <- (1 - m_c / M) * S2_b / m_c
sd_c <- sqrt(var_c)

students_per_cluster <- N / M
S2_w <- student_data %>%
  group_by(id_cv) %>%
  summarise(var_in_cluster = var(body)) %>%
  pull(var_in_cluster) %>%
  mean(na.rm = TRUE)

icc <- (S2_b - S2_w / students_per_cluster) / (S2_b + (students_per_cluster - 1) * S2_w / students_per_cluster)
```
Teoretická směrodatná odchylka odhadu průměru je `r round(sd_c, 4)`. Vnitrotřídní korelační koeficient (ICC) je `r round(icc, 4)`. Kladná hodnota ICC naznačuje, že studenti v rámci jednoho cvičení si jsou podobnější než studenti napříč cvičeními, což snižuje efektivitu skupinkového výběru.

#### d) 

Vybíráme 1/5 cvičení (16 cvičení) a v každém z nich 1/2 studentů (10 studentů). Odhad průměru je nestranný.

```{r theo_d}
n2 <- 10 
var_d <- (1 - m_d / M) * S2_b / m_d + (1 - n2 / students_per_cluster) * S2_w / (m_d * n2)
sd_d <- sqrt(var_d)
```
Teoretická směrodatná odchylka odhadu průměru je `r round(sd_d, 4)`.

#### Závěr k teoretické části
Pokud předpokládáme, že studenti v rámci cvičení jsou si podobní (kladné ICC), pak skupinkový a vícestupňový výběr nejsou ideální volbou. Jejich variabilita je vyšší než u prostého náhodného výběru. Stratifikovaný výběr se zdá být nejpřesnější, protože bere v potaz rozdíly mezi typy oborů.

| Metoda                     | Teoretická směrodatná odchylka |
|----------------------------|--------------------------------|
| a) Prostý náhodný výběr    | `r round(sd_a, 4)`             |
| b) Stratifikovaný výběr    | `r round(sd_b, 4)`             |
| c) Skupinkový výběr        | `r round(sd_c, 4)`             |
| d) Dvoustupňový výběr      | `r round(sd_d, 4)`             |

### iii) Simulační studie


```{r simulation}
R <- 500
results <- data.frame(
  replication = 1:R,
  srs_mean = numeric(R),
  strat_mean = numeric(R),
  cluster_mean = numeric(R),
  twostage_mean = numeric(R)
)

allocation <- table(student_data$typ) / 10

for (i in 1:R) {
  # a) SRS
  srs_sample_ids <- sample(1:N, size = n, replace = FALSE)
  srs_sample <- student_data[srs_sample_ids, ]
  results$srs_mean[i] <- mean(srs_sample$body)
  
  # b) Stratified
  strat_sample_ids <- strata(student_data, stratanames = "typ", size = allocation, method = "srswor")$ID_unit
  strat_sample <- student_data[strat_sample_ids, ]
  results$strat_mean[i] <- mean(strat_sample$body)

  # c) Cluster
  cluster_ids <- sample(1:M, size = m_c, replace = FALSE)
  cluster_sample <- student_data[student_data$id_cv %in% cluster_ids, ]
  results$cluster_mean[i] <- mean(cluster_sample$body)

  # d) Two-stage
  stage1_ids <- sample(1:M, size = m_d, replace = FALSE)
  stage1_sample <- student_data[student_data$id_cv %in% stage1_ids, ]
  
  twostage_sample <- stage1_sample %>%
    group_by(id_cv) %>%
    sample_n(size = n2, replace = FALSE)
  results$twostage_mean[i] <- mean(twostage_sample$body)
}

results_long <- tidyr::gather(results, key = "method", value = "mean_estimate", -replication)
results_long$method <- factor(results_long$method, 
                              levels = c("srs_mean", "strat_mean", "cluster_mean", "twostage_mean"),
                              labels = c("a) SRS", "b) Stratified", "c) Cluster", "d) Two-stage"))
```

```{r plot, fig.width=10, fig.height=6}
ggplot(results_long, aes(x = method, y = mean_estimate, fill = method)) +
  geom_boxplot() +
  geom_hline(yintercept = true_mean, linetype = "dashed", color = "red", size = 1) +
  labs(
    title = "Porovnání přesnosti odhadů průměru pro různé výběrové plány",
    subtitle = paste("R = 500 replikací, skutečný průměr =", round(true_mean, 2)),
    x = "Metoda výběru",
    y = "Odhad průměrného počtu bodů"
  ) +
  theme_minimal() +
  theme(legend.position = "none")
```

Graf ukazuje, že všechny metody poskytují nestranné odhady. Stratifikovaný výběr má viditelně nejmenší rozptyl, což potvrzuje teoretické výpočty. Naopak skupinkový výběr má největší rozptyl.
